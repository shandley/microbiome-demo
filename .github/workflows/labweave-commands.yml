# LabWeave Issue Commands
# Responds to /status, /methods, /provenance, /timeline commands in GitHub Issues

name: LabWeave Commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  handle-command:
    if: startsWith(github.event.comment.body, '/')
    runs-on: ubuntu-latest
    name: Handle LabWeave command

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get project ID from metadata
        id: metadata
        run: |
          if [ -f ".labweave-metadata.json" ]; then
            PROJECT_ID=$(jq -r '.project_id' .labweave-metadata.json)
            echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          else
            PROJECT_ID="${{ github.repository }}"
            PROJECT_ID=$(echo "$PROJECT_ID" | tr '/' '-')
            echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          fi

      - name: Parse command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          COMMAND=$(echo "$COMMENT" | head -1 | awk '{print $1}')
          ARGS=$(echo "$COMMENT" | head -1 | cut -d' ' -f2-)
          if [ "$ARGS" = "$COMMAND" ]; then
            ARGS=""
          fi
          echo "command=$COMMAND" >> $GITHUB_OUTPUT
          echo "args=$ARGS" >> $GITHUB_OUTPUT

      - name: Handle /help
        if: steps.parse.outputs.command == '/help'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## LabWeave Commands

            | Command | Description |
            |---------|-------------|
            | \`/status\` | Show project summary (commits, methods, parameters) |
            | \`/methods\` | List all detected analysis methods |
            | \`/provenance\` | List all tracked parameters |
            | \`/provenance <name>\` | Show history for a specific parameter |
            | \`/timeline\` | Show recent commits with changes |
            | \`/help\` | Show this help |

            ---
            *LabWeave - Your Research Intelligence Partner*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle /status
        if: steps.parse.outputs.command == '/status'
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          PROJECT_ID: ${{ steps.metadata.outputs.project_id }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo '{"error": "LABWEAVE_API_URL secret not configured"}' > /tmp/response.json
          else
            curl -s "${LABWEAVE_API_URL}/api/v1/ingest/status?project_id=${PROJECT_ID}" > /tmp/response.json || echo '{"error": "Could not connect to LabWeave API"}' > /tmp/response.json
          fi
          cat /tmp/response.json
          echo "RESPONSE<<EOF" >> $GITHUB_ENV
          cat /tmp/response.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post /status response
        if: steps.parse.outputs.command == '/status'
        uses: actions/github-script@v7
        with:
          script: |
            const formatDate = (isoString) => {
              if (!isoString) return 'Never';
              const date = new Date(isoString);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            let response;
            try {
              response = JSON.parse(process.env.RESPONSE || '{}');
            } catch (e) {
              response = { error: 'Invalid API response' };
            }

            let body;
            if (response.error) {
              body = `## Status Unavailable

            Could not retrieve project status: **${response.error}**

            *Check that the repository has \`LABWEAVE_API_URL\` secret configured.*`;
            } else {
              body = `## Project Status

            | Metric | Value |
            |--------|-------|
            | Total Commits | ${response.total_commits ?? 0} |
            | Last Ingestion | ${formatDate(response.last_ingestion)} |
            | Methods Detected | ${response.methods_count ?? 0} |
            | Parameters Tracked | ${response.parameters_count ?? 0} |

            *Use \`/methods\` to see detected methods or \`/provenance\` to see tracked parameters.*`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle /methods
        if: steps.parse.outputs.command == '/methods'
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          PROJECT_ID: ${{ steps.metadata.outputs.project_id }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo '{"error": "LABWEAVE_API_URL secret not configured"}' > /tmp/response.json
          else
            curl -s "${LABWEAVE_API_URL}/api/v1/provenance/methods/${PROJECT_ID}/list" > /tmp/response.json || echo '{"error": "Could not connect to LabWeave API"}' > /tmp/response.json
          fi
          echo "METHODS_RESPONSE<<EOF" >> $GITHUB_ENV
          cat /tmp/response.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post /methods response
        if: steps.parse.outputs.command == '/methods'
        uses: actions/github-script@v7
        with:
          script: |
            let response;
            try {
              response = JSON.parse(process.env.METHODS_RESPONSE || '[]');
            } catch (e) {
              response = { error: 'Invalid API response' };
            }

            let body;
            if (response.error) {
              body = `## Methods Unavailable

            Could not retrieve methods: **${response.error}**`;
            } else if (!Array.isArray(response) || response.length === 0) {
              body = `## Analysis Methods

            No methods detected yet.

            Methods are detected automatically when you commit code that uses analysis tools like:
            - Statistical tests (t-test, ANOVA, PERMANOVA)
            - Differential expression (DESeq2, edgeR, limma)
            - Machine learning (random forest, SVM)
            - Microbiome tools (DADA2, QIIME2)`;
            } else {
              let table = '| Method | Times Used |\n|--------|------------|\n';
              for (const method of response) {
                table += `| \`${method.method_name}\` | ${method.usage_count} |\n`;
              }
              const totalUsages = response.reduce((sum, m) => sum + m.usage_count, 0);
              body = `## Analysis Methods

            ${table}

            *${response.length} method${response.length === 1 ? '' : 's'} detected across ${totalUsages} usage${totalUsages === 1 ? '' : 's'}*`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle /provenance
        if: steps.parse.outputs.command == '/provenance'
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          PARAM_NAME: ${{ steps.parse.outputs.args }}
          PROJECT_ID: ${{ steps.metadata.outputs.project_id }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo '{"error": "LABWEAVE_API_URL secret not configured"}' > /tmp/response.json
          elif [ -n "$PARAM_NAME" ]; then
            curl -s "${LABWEAVE_API_URL}/api/v1/provenance/parameters/${PROJECT_ID}?parameter_name=${PARAM_NAME}&days=90" > /tmp/response.json || echo '{"error": "Could not connect to LabWeave API"}' > /tmp/response.json
          else
            curl -s "${LABWEAVE_API_URL}/api/v1/provenance/parameters/${PROJECT_ID}/list" > /tmp/response.json || echo '{"error": "Could not connect to LabWeave API"}' > /tmp/response.json
          fi
          echo "PROVENANCE_RESPONSE<<EOF" >> $GITHUB_ENV
          cat /tmp/response.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "PARAM_QUERY=$PARAM_NAME" >> $GITHUB_ENV

      - name: Post /provenance response
        if: steps.parse.outputs.command == '/provenance'
        uses: actions/github-script@v7
        with:
          script: |
            const formatDate = (isoString) => {
              if (!isoString) return 'N/A';
              const date = new Date(isoString);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            let response;
            try {
              response = JSON.parse(process.env.PROVENANCE_RESPONSE || '{}');
            } catch (e) {
              response = { error: 'Invalid API response' };
            }
            const paramName = process.env.PARAM_QUERY;

            let body;
            if (response.error) {
              body = `## Provenance Unavailable

            Could not retrieve provenance data: **${response.error}**`;
            } else if (paramName && response.changes !== undefined) {
              // Specific parameter history
              if (response.changes.length === 0) {
                body = `## Parameter History: \`${paramName}\`

            No changes found for this parameter in the last 90 days.

            *Use \`/provenance\` without arguments to see all tracked parameters.*`;
              } else {
                let table = '| Date | Old Value | New Value | Commit | Author |\n|------|-----------|-----------|--------|--------|\n';
                for (const change of response.changes.slice(0, 10)) {
                  const date = formatDate(change.commit_time);
                  const sha = change.commit_sha.substring(0, 7);
                  table += `| ${date} | \`${change.old_value || '-'}\` | \`${change.new_value}\` | \`${sha}\` | ${change.author} |\n`;
                }
                body = `## Parameter History: \`${paramName}\`

            ${table}

            *Showing ${Math.min(response.changes.length, 10)} of ${response.total_changes} change${response.total_changes === 1 ? '' : 's'}*`;
              }
            } else if (Array.isArray(response)) {
              // List of all parameters
              if (response.length === 0) {
                body = `## Tracked Parameters

            No parameters tracked yet.

            Parameters are detected automatically when you modify values in your code, such as:
            - \`alpha = 0.05\` (significance threshold)
            - \`rarefaction_depth = 10000\`
            - \`n_iterations = 1000\``;
              } else {
                let table = '| Parameter | Changes | Last Changed |\n|-----------|---------|-------------|\n';
                for (const param of response.slice(0, 15)) {
                  const lastChanged = formatDate(param.last_changed);
                  table += `| \`${param.parameter_name}\` | ${param.change_count} | ${lastChanged} |\n`;
                }
                body = `## Tracked Parameters

            ${table}

            *Use \`/provenance <parameter_name>\` to see the full history for a parameter.*`;
              }
            } else {
              body = `## Parameter Tracking

            No parameter data available yet.

            Parameters are detected automatically when you modify values in your code.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle /timeline
        if: steps.parse.outputs.command == '/timeline'
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          PROJECT_ID: ${{ steps.metadata.outputs.project_id }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo '{"error": "LABWEAVE_API_URL secret not configured"}' > /tmp/response.json
          else
            curl -s "${LABWEAVE_API_URL}/api/v1/provenance/timeline/${PROJECT_ID}?days=7" > /tmp/response.json || echo '{"error": "Could not connect to LabWeave API"}' > /tmp/response.json
          fi
          echo "TIMELINE_RESPONSE<<EOF" >> $GITHUB_ENV
          cat /tmp/response.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post /timeline response
        if: steps.parse.outputs.command == '/timeline'
        uses: actions/github-script@v7
        with:
          script: |
            const formatDate = (isoString) => {
              if (!isoString) return 'N/A';
              const date = new Date(isoString);
              return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            };

            let response;
            try {
              response = JSON.parse(process.env.TIMELINE_RESPONSE || '[]');
            } catch (e) {
              response = { error: 'Invalid API response' };
            }

            let body;
            if (response.error) {
              body = `## Timeline Unavailable

            Could not retrieve timeline: **${response.error}**`;
            } else if (!Array.isArray(response) || response.length === 0) {
              body = `## Project Timeline

            No commits found in the last 7 days.

            *Commits are tracked automatically when pushed to this repository.*`;
            } else {
              let timeline = '';
              for (const commit of response.slice(0, 10)) {
                const date = formatDate(commit.commit_time);
                const sha = commit.commit_sha.substring(0, 7);
                const msg = commit.commit_message.split('\n')[0].substring(0, 50);

                let extras = [];
                if (commit.parameters_changed && commit.parameters_changed.length > 0) {
                  extras.push(`params: ${commit.parameters_changed.join(', ')}`);
                }
                if (commit.methods_used && commit.methods_used.length > 0) {
                  extras.push(`methods: ${commit.methods_used.join(', ')}`);
                }
                const extrasStr = extras.length > 0 ? `\n  - *${extras.join(' | ')}*` : '';

                timeline += `- **${date}** [\`${sha}\`](https://github.com/${{ github.repository }}/commit/${commit.commit_sha}) ${msg}${extrasStr}\n`;
              }

              body = `## Project Timeline (Last 7 Days)

            ${timeline}

            *${response.length} commit${response.length === 1 ? '' : 's'} tracked*`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle unknown command
        if: |
          steps.parse.outputs.command != '/help' &&
          steps.parse.outputs.command != '/status' &&
          steps.parse.outputs.command != '/methods' &&
          steps.parse.outputs.command != '/provenance' &&
          steps.parse.outputs.command != '/timeline'
        uses: actions/github-script@v7
        with:
          script: |
            const command = '${{ steps.parse.outputs.command }}';
            const body = `Unknown command: \`${command}\`

            Use \`/help\` to see available commands.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
