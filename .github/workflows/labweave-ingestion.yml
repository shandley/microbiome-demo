# LabWeave Commit Ingestion
# Automatically sends commit data to LabWeave for analysis

name: LabWeave Ingestion

on:
  push:
    branches: [main]

jobs:
  ingest:
    runs-on: ubuntu-latest
    name: Ingest commit to LabWeave

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Build and send payload
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          LABWEAVE_TOKEN: ${{ secrets.LABWEAVE_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          AUTHOR_EMAIL: ${{ github.event.head_commit.author.email }}
          AUTHOR_USERNAME: ${{ github.event.head_commit.author.username }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPOSITORY: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo "LABWEAVE_API_URL not configured, skipping ingestion"
            exit 0
          fi

          # Get metadata from file
          if [ -f ".labweave-metadata.json" ]; then
            PROJECT_ID=$(jq -r '.project_id // empty' .labweave-metadata.json)
            PROJECT_NAME=$(jq -r '.project_name // empty' .labweave-metadata.json)
            RESEARCHERS=$(jq -c '.team // []' .labweave-metadata.json)
            DESCRIPTION=$(jq -r '.description // empty' .labweave-metadata.json)
          fi
          PROJECT_ID="${PROJECT_ID:-$REPOSITORY}"
          PROJECT_NAME="${PROJECT_NAME:-microbiome-demo}"
          RESEARCHERS="${RESEARCHERS:-[]}"

          # Build files array
          FILES_JSON="[]"
          for file in $(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-tree --name-only -r HEAD); do
            STATUS="modified"
            if ! git show HEAD~1:"$file" &>/dev/null 2>&1; then
              STATUS="added"
            fi
            # Get the patch and properly escape it
            PATCH=$(git diff HEAD~1 HEAD -- "$file" 2>/dev/null | head -c 5000 || echo "")
            FILES_JSON=$(echo "$FILES_JSON" | jq \
              --arg f "$file" \
              --arg s "$STATUS" \
              --arg p "$PATCH" \
              '. + [{"filename": $f, "status": $s, "additions": 0, "deletions": 0, "changes": 0, "patch": $p}]')
          done

          # Build full payload
          PAYLOAD=$(jq -n \
            --arg sha "$COMMIT_SHA" \
            --arg message "$COMMIT_MESSAGE" \
            --arg author_name "$AUTHOR_NAME" \
            --arg author_email "$AUTHOR_EMAIL" \
            --arg author_username "$AUTHOR_USERNAME" \
            --arg timestamp "$COMMIT_TIMESTAMP" \
            --arg repository "$REPOSITORY" \
            --arg repository_url "https://github.com/$REPOSITORY" \
            --arg branch "$BRANCH" \
            --argjson files "$FILES_JSON" \
            --arg project_id "$PROJECT_ID" \
            --arg project_name "$PROJECT_NAME" \
            --argjson researchers "$RESEARCHERS" \
            --arg description "$DESCRIPTION" \
            '{
              sha: $sha,
              message: $message,
              timestamp: $timestamp,
              branch: $branch,
              author: {
                name: $author_name,
                email: $author_email,
                username: $author_username
              },
              files: $files,
              repository: $repository,
              repository_url: $repository_url,
              metadata: {
                schema_version: "1.0",
                project_id: $project_id,
                title: $project_name,
                researchers: $researchers,
                description: $description
              }
            }')

          echo "Sending commit $COMMIT_SHA to LabWeave..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${LABWEAVE_API_URL}/api/v1/ingest/commit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LABWEAVE_TOKEN}" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully ingested commit"
            echo "$BODY" | jq .
          else
            echo "Failed to ingest commit (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
