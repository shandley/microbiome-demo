# LabWeave Commit Ingestion
# Automatically sends commit data to LabWeave for analysis

name: LabWeave Ingestion

on:
  push:
    branches: [main]

jobs:
  ingest:
    runs-on: ubuntu-latest
    name: Ingest commit to LabWeave

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit diff
        id: diff
        run: |
          DIFF=$(git diff HEAD~1 HEAD -- . ':(exclude)*.lock' ':(exclude)package-lock.json' 2>/dev/null | head -c 50000 || echo "Initial commit")
          # Escape for JSON
          DIFF_ESCAPED=$(echo "$DIFF" | jq -Rs .)
          echo "diff=$DIFF_ESCAPED" >> $GITHUB_OUTPUT

      - name: Get changed files as JSON
        id: files
        run: |
          # Build files array with proper structure
          FILES_JSON="[]"
          for file in $(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-tree --name-only -r HEAD); do
            STATUS="modified"
            if ! git show HEAD~1:"$file" &>/dev/null 2>&1; then
              STATUS="added"
            fi
            PATCH=$(git diff HEAD~1 HEAD -- "$file" 2>/dev/null | head -c 5000 || echo "")
            PATCH_ESCAPED=$(echo "$PATCH" | jq -Rs .)
            FILES_JSON=$(echo "$FILES_JSON" | jq --arg f "$file" --arg s "$STATUS" --argjson p "$PATCH_ESCAPED" '. + [{"filename": $f, "status": $s, "additions": 0, "deletions": 0, "changes": 0, "patch": $p}]')
          done
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get project metadata
        id: metadata
        run: |
          if [ -f ".labweave-metadata.json" ]; then
            PROJECT_ID=$(jq -r '.project_id // empty' .labweave-metadata.json)
            PROJECT_NAME=$(jq -r '.project_name // empty' .labweave-metadata.json)
            RESEARCHERS=$(jq -c '.team // []' .labweave-metadata.json)
            DESCRIPTION=$(jq -r '.description // empty' .labweave-metadata.json)
          fi
          echo "project_id=${PROJECT_ID:-${{ github.repository }}}" >> $GITHUB_OUTPUT
          echo "project_name=${PROJECT_NAME:-${{ github.event.repository.name }}}" >> $GITHUB_OUTPUT
          echo "researchers=${RESEARCHERS:-[]}" >> $GITHUB_OUTPUT
          echo "description=${DESCRIPTION:-}" >> $GITHUB_OUTPUT

      - name: Send to LabWeave
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          LABWEAVE_TOKEN: ${{ secrets.LABWEAVE_TOKEN }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo "LABWEAVE_API_URL not configured, skipping ingestion"
            exit 0
          fi

          # Build the payload matching the API schema
          PAYLOAD=$(jq -n \
            --arg sha "${{ github.sha }}" \
            --arg message "${{ github.event.head_commit.message }}" \
            --arg author_name "${{ github.event.head_commit.author.name }}" \
            --arg author_email "${{ github.event.head_commit.author.email }}" \
            --arg author_username "${{ github.event.head_commit.author.username }}" \
            --arg timestamp "${{ github.event.head_commit.timestamp }}" \
            --arg repository "${{ github.repository }}" \
            --arg repository_url "https://github.com/${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --argjson files '${{ steps.files.outputs.files }}' \
            --arg project_id "${{ steps.metadata.outputs.project_id }}" \
            --arg project_name "${{ steps.metadata.outputs.project_name }}" \
            --argjson researchers '${{ steps.metadata.outputs.researchers }}' \
            --arg description "${{ steps.metadata.outputs.description }}" \
            '{
              sha: $sha,
              message: $message,
              timestamp: $timestamp,
              branch: $branch,
              author: {
                name: $author_name,
                email: $author_email,
                username: $author_username
              },
              files: $files,
              repository: $repository,
              repository_url: $repository_url,
              metadata: {
                schema_version: "1.0",
                project_id: $project_id,
                title: $project_name,
                researchers: $researchers,
                description: $description
              }
            }')

          echo "Sending commit ${{ github.sha }} to LabWeave..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${LABWEAVE_API_URL}/api/v1/ingest/commit" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LABWEAVE_TOKEN}" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully ingested commit"
            echo "$BODY" | jq .
          else
            echo "Failed to ingest commit (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
