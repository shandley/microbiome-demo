# LabWeave Daily Feedback
# Generates AI insights and posts as GitHub Issue

name: LabWeave Daily Feedback

on:
  schedule:
    - cron: '0 8 * * *'  # 8 AM UTC daily
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  generate-feedback:
    runs-on: ubuntu-latest
    name: Generate daily insights

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get project metadata
        id: metadata
        run: |
          if [ -f ".labweave-metadata.json" ]; then
            PROJECT_ID=$(jq -r '.project_id' .labweave-metadata.json)
            PROJECT_NAME=$(jq -r '.project_name' .labweave-metadata.json)
          fi
          echo "project_id=${PROJECT_ID:-microbiome-demo}" >> $GITHUB_OUTPUT
          echo "project_name=${PROJECT_NAME:-Microbiome Demo}" >> $GITHUB_OUTPUT

      - name: Request feedback from LabWeave
        id: feedback
        env:
          LABWEAVE_API_URL: ${{ secrets.LABWEAVE_API_URL }}
          PROJECT_ID: ${{ steps.metadata.outputs.project_id }}
        run: |
          if [ -z "$LABWEAVE_API_URL" ]; then
            echo "LABWEAVE_API_URL not configured"
            exit 0
          fi

          RESPONSE=$(curl -s -X POST "${LABWEAVE_API_URL}/api/v1/feedback/generate" \
            -H "Content-Type: application/json" \
            -d "{\"project_id\": \"${PROJECT_ID}\", \"days\": 7}")

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create feedback issue
        if: steps.feedback.outputs.response != ''
        uses: actions/github-script@v7
        with:
          script: |
            const response = JSON.parse(`${{ steps.feedback.outputs.response }}`);

            if (!response.feedback || response.feedback === 'No commits found') {
              console.log('No feedback to post');
              return;
            }

            const today = new Date().toISOString().split('T')[0];
            const title = `LabWeave Insights: ${today}`;

            const body = `## Daily Research Intelligence

            ${response.feedback}

            ---

            **Commits Analyzed:** ${response.commits_analyzed || 0}
            **Period:** Last 7 days

            *Generated by LabWeave*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['labweave-feedback', 'automated']
            });
